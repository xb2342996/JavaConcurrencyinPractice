# 组合对象
## 设计线程安全的类 design thread-safe class
设计线程安全的类应该包括下面3个基本要素：
+ 确定对象状态是由那些变量构成；
+ 确定限制状态变量的不变约束；
+ 制定一个管理并发访问对象状态的策略。

同步策略定义了对象如何协调对其状态的访问，并且不会违反他的不变约束或后验条件。

### 收集同步需求
维护类的线程安全性意味着要确保在并发访问的情况下，保护她的不变约束；需要对类的状态进行判断。
<br>对象与变量拥有一个状态空间（status space）：即他们可能处于的状态。状态空间越小，越容易判断。
<br>尽量使用final类型的域来简化我们对对象的可能状态进行分析。
<br>很多类通过不可变约束来判定一种状态是合法的还是非法的。
<br>操作的后验条件会指出某种状态转换是非法的。
<br>不变约束与后验条件施加在状态及状态转换上的约束，引入了额外的同步与封装。如果某些状态是非法的，则必须封装该状态下的状态变量。
<br>如果一个操作的过程可能出现非法状态转换，则这个操作必须是原子的。

### 状态依赖操作
类的不变约束与方法后验条件约束了对象的合法状态和合法状态转换。某些对象的方法也有基于状态的先验条件。

### 状态所有权
很多情况下，所有权与封装权总是同时出现：对象封装他拥有的状态，且拥有他封装的状态。拥有给定状态的所有者决定了锁协议，该协议用于维护变量状态的完整性。所有权意味着控制权，一旦你将引用发布到一个可变对象上，你不再拥有独占的控制权，充其量只有共享控制权。类通常不会拥有构造函数或方法传递进来的对象，除非该方法是被明确设计用来转换对象的所有权。